# 一、URL解析

解析URL，生成发送给Web服务器的请求信息。

![image-20220501152903913](%E8%BE%93%E5%85%A5URL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.assets/image-20220501152903913.png)

如果URL中的资源信息全部省略，代表访问默认的/index.html或者default.html。

生成HTTP请求信息：

![image-20220501153053594](%E8%BE%93%E5%85%A5URL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.assets/image-20220501153053594.png)



# 二 DNS 解析

通过浏览器解析URL并生成HTTP消息后，需要委托操作系统将消息发送给Web服务器。发松前需要进行DNS解析查找服务器域名对应的IP地址。

具体过程如下：

（1）首先是查找浏览器缓存，浏览器会保存一段时间内访问过的一些网址的DNS信息，不同浏览器保存的时长不等。

（2）如果没有找到对应的记录，则首先检查 host 文件中是否存在网址的映射关系，如果有，直接返回，完成域名解析。

（3）如果还是没找到对应的IP，那么接着会发送一个请求到本地DNS服务器（TCP/IP参数中设置的首选DNS服务器），此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。

（4）如果要查询的域名，不由本地 DNS 服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个 IP 地址映射，完成域名解析，此解析不具有权威性。

（5）如果本地 DNS 服务器本地区域文件与缓存解析都失效，则根据本地 DNS 服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地 DNS 就把请求发至 13 台根 DNS，根 DNS 服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个 IP。本地 DNS 服务器收到IP信息后，将会联系负责 .com 域的这台服务器。这台负责 .com 域的服务器收到请求后，如果自己无法解析，它就会找一个管理 .com 域的下一级DNS服务器地址`http://qq.com`给本地 DNS 服务器。当本地DNS服务器收到这个地址后，就会找`http://qq.com`域服务器，重复上面的动作，进行查询，直至找到`www.qq.com`主机。

（6）如果用的是转发模式，此 DNS 服务器就会把请求转发至上一级 DNS 服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根 DNS 或把转请求转至上上级，以此循环。不管是本地 DNS 服务器用是是转发，还是根提示，最后都是把结果返回给本地 DNS服务器，本地 DNS 服务器再返回给客户机。



# 三 进行 TCP 连接

浏览器得到了IP后，向服务器发起建立TCP连接的请求。

所谓的「连接」，只是双方计算机里维护一个状态机，在连接建立的过程中，双方的状态变化时序图就像这样。

![image-20220501154132512](%E8%BE%93%E5%85%A5URL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.assets/image-20220501154132512.png)

建立连接后，网络包的内容如下：

![image-20220501154925216](%E8%BE%93%E5%85%A5URL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.assets/image-20220501154925216.png)





# 四 IP定位

TCP 模块在执行连接、收发、断开等各阶段操作时，都需要委托 IP 模块将数据封装成**网络包**发送给通信对象。

生成IP报文：

![image-20220501155238205](%E8%BE%93%E5%85%A5URL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.assets/image-20220501155238205.png)





# 五 添加MAC头部

一般在 TCP/IP 通信里，MAC 包头的**协议类型**只使用：

- `0800` ： IP 协议
- `0806` ： ARP 协议

发送方的MAC地址为网卡的MAC地址，接收方的MAC地址为路由表里的目标地址，假设需要发给x，则通过ARP协议找到x的物理地址，随后填充帧头部。

ARP将首先查询缓存，缓存未命中时发送广播。

# 六 网卡

网卡驱动获取网络包之后，会将其**复制**到网卡内的缓存区中，接着会在其**开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列**。

![image-20220501155736631](%E8%BE%93%E5%85%A5URL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.assets/image-20220501155736631.png)

- 起始帧分界符是一个用来表示包起始位置的标记
- 末尾的 `FCS`（帧校验序列）用来检查包传输过程是否有损坏

然后将包转换为电信号发送出去。

# 七 交换机

电信号到达交换机网线口，交换机中的模块接收电信号并转换为数字信号，通过包末尾的FCS校验错误，如果没问题则放到缓冲区。

交换机不具有MAC地址，仅仅对FCS进行校验，然后放到缓冲区。

将包存入缓冲区后，接下来需要查询一下这个包的接收方 MAC 地址是否已经在 MAC 地址表中有记录了。

交换机的 MAC 地址表主要包含两个信息：

- 一个是设备的 MAC 地址，
- 另一个是该设备连接在交换机的哪个端口上。

![image-20220501160049659](%E8%BE%93%E5%85%A5URL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.assets/image-20220501160049659.png)

**交换机根据 MAC 地址表查找 MAC 地址，然后将信号发送到相应的端口**。

> 当交换机的MAC地址表找不到对应的MAC地址时，会将包转发到除发送端口外的所有地址。

# 八 路由器

路由器的端口具有MAC地址，它能够成为以太网的发送方和接收方，同时还具有IP地址，某种意义上说和网卡是一样的。

路由器工作原理：

- 电信号到达网口，然后转换为数字信号，通过包末尾的FCS进行错误校验
- 检查MAC地址和自身MAC地址是否匹配
- 去掉MAC头部，得到目标IP，根据路由表进行路由匹配
- 如果匹配的路由策略中，网关为空，则这个IP地址就是我们要转发到的目标地址，路由器直接通过ARP协议找到目标IP的MAC地址进行发送。如果网关不为空，则通过ARP得到该网关IP地址的MAC地址，转发给网关。

# 九 服务器端

服务器收到数据包后，去除头部，并向客户端回复响应报文，浏览器得到响应报文后进行渲染。







服务器收到浏览器的请求以后，会解析这个请求（读请求头），然后生成一个响应头和具体响应内容。接着服务器会传回来一个响应头和一个响应，响应头告诉了浏览器一些必要的信息，例如重要的Status Code，2开头如200表示一切正常，3开头表示重定向，4开头是客户端错误，如404表示请求的资源不存在，5开头表示服务器端错误。响应就是具体的要请求的页面内容。

五 浏览器解析渲染页面
（1）浏览器显示HTML

当服务器返回响应之后，浏览器读取关于这个响应的说明书（响应头），然后开始解析这个响应并在页面上显示出来。

浏览器打开一个网址的时候会慢慢加载这个页面，一部分一部分的显示，直到完全显示，知道最后的旋转进度条停止。因此在浏览器没有完整接受全部HTML文档时，它就已经开始显示这个页面了。

（2）浏览器向服务器发送请求获取嵌入在HTML中的对象

在浏览器显示HTML时，打开一个网页的过程中，主页（index）页面框架传送过来以后，浏览器还会因页面上的静态资源多次发起连接请求，需要获取嵌入在HTML中的其他地址的资源。这时，浏览器会发送一些请求来获取这些文件。这些内容也要一点点地请求过来，所以标签栏转啊转，内容刷啊刷，最后全部请求并加载好了就终于好了。

这时请求的内容是主页里面包含的一些资源，如图片，视频，css样式，JavaScript文件等等。

这在文件属于静态文件，首次访问会留在浏览器的缓存中，过期才会从服务器去取。缓存的内容通常不会保存很久，因为难保网站不会被改动。

静态的文件一般会从CDN中去取，CDN根据请求获取资源的时候可能还会用到负载均衡。

（3）浏览器发送异步（AJAX）请求

对于那些动态的请求，动态网页等就必须要从服务器获取了。对于静态的页面内容，浏览器通常会进行缓存，而对于动态的内容，浏览器通常不会进行缓存。对于这些动态请求，Nginx可能会专门设置一些服务器用来处理这些访问动态页面的请求。

六 关闭TCP连接
当数据完成请求到返回的过程之后，根据Connection的Keep-Alive属性可以选择是否断开TCP连接，HTTP/1.1一般支持同一个TCP多个请求，而不是1.0版本下的完成一次请求就发生断开。TCP的断开与连接不一样，断开可以分为主动关闭和被动关闭，需要经过4次握手。

当浏览器需要的全部数据都已经加载完毕，一个页面就显示完了。