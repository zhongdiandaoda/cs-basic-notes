## 1.什么是DNS？

DNS( Domain Name System)是“域名系统”的英文缩写，是一种组织成域层次结构的计算机和网络服务命名系统，域名是群体中所有人都在用的，必须要保持唯一性。为了达到唯一性的目的，因特网在命名的时候采用了层次结构的命名方法。

每一个域名（本文只讨论英文域名）都是一个标号序列（labels），用字母（A-Z，a-z，大小写等价）、数字（0-9）和连接符（-）组成，标号序列总长度不能超过255个字符，它由点号分割成一个个的标号（label），每个标号应该在63个字符之内，每个标号都可以看成一个层次的域名。级别最低的域名写在左边，级别最高的域名写在右边。

域名最后的`.`号表示根域名，最开始的域名在最后都是带了点号的，后来发现所有的网址都要加上最后的点，就简化了写法，干脆所有的都不加，但是在网址后面加上点号也是可以正常解析的。

DNS占用53号端口，同时使用TCP和UDP协议。

## 2.DNS域名空间

域名系统作为一个层次结构和分布式数据库，包含各种类型的数据，包括主机名和域名。DNS数据库中的名称形成一个分层树状结构称为域命名空间。

根域名服务器：最高层次的域名服务器，也是最重要的域名服务器，本地域名服务器如果解析不了域名就会向根域名服务器求助。全球共有13个不同IP地址的根域名服务器，它们的名称用一个英文字母命名，从a一直到m。这些服务器由各种组织控制，并由 ICANN（互联网名称和数字地址分配公司）授权，由于每分钟都要解析的名称数量多得令人难以置信，所以实际上每个根服务器都有镜像服务器，**每个根服务器与它的镜像服务器共享同一个 IP 地址，**中国大陆地区内只有6组根服务器镜像（F，I（3台），J，L）。当你对某个根服务器发出请求时，请求会被路由到该根服务器离你最近的镜像服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和地址，如果向根服务器发出对 `“xujiyou.work”` 的请求，则根服务器是不能在它的记录文件中找到与`“xujiyou.work”` 匹配的记录。但是它会找到 `“work”` 的顶级域名记录，并把负责`“work”` 地址的顶级域名服务器的地址发回给请求者。

顶级域名服务器：用来指示某个国家、地区或者组织。采用三个字符，如`com` -> 商业公司，`edu` -> 教育机构，`net` -> 网络公司，`gov` -> 非军事政府机构等等。

二级域：个人或者组织在Internet使用的注册名称。采用两个字符，如：`cn` -> 代表中国，`jp` -> 日本，`uk` -> 英国，`hk` -> 香港等等。

主机：主机名处于域名空间结构中的最底层，主机名和域名结合构成FQDN，主机名是FQDN最左端的部分

## 3.DNS的获取流程

DNS是应用层协议，事实上他是为其他应用层协议工作的，包括不限于 HTTP 和 SMTP 以及 FTP，用于将用户提供的主机名解析为 IP 地址。

具体过程如下：

①用户主机上运行着 DNS 的客户端，就是我们的 PC 机或者手机客户端运行着 DNS 客户端了。

②浏览器将接收到的`url`中抽取出域名字段，就是访问的主机名，比如`http://www.baidu.com/`，并将这个主机名传送给 DNS 应用的客户端。

③DNS 客户机端向 DNS 服务器端发送一份查询报文，报文中包含着要访问的主机名字段（中间包括一些列缓存查询以及分布式 DNS 集群的工作）。

④该 DNS 客户机最终会收到一份回答报文，其中包含有该主机名对应的 IP 地址。

⑤一旦该浏览器收到来自 DNS 的 IP 地址，就可以向该IP地址定位的 HTTP 服务器发起 TCP 连接

## 4.DNS服务的体系架构

DNS服务的作用：把域名解析为 IP 地址，将 IP 地址解析为域名。

假设运行在用户主机上的某些应用程序（如 Web 浏览器或者邮件阅读器）需要将主机名转换为 IP 地址。这些应用程序将调用 DNS 的客户机端，并指明需要被转换的主机名。（在很多基于 UNIX 的机器上，应用程序为了执行这种转换需要调用函数`gethostbyname()`）。用户主机的 DNS 客户端接收到后，向网络中发送一个 DNS 查询报文。经过若干毫秒到若干秒的延时后，用户主机上的 DNS 客户端接收到一个提供所希望映射的 DNS 应答报文。这个查询结果则被传递到调用 DNS 服务的应用程序。因此，从用户主机上应用程序的角度看，DNS是一个提供简单、直接的转换服务的黑盒子。但事实上，实现这个服务的黑盒子非常复杂，它由分布于全球的大量 DNS 服务器以及定义了 DNS 服务器与查询主机通信方式的应用层协议组成。

## 5.DNS服务的工作过程

当 DNS 客户端需要查询程序中使用的名称时，它会查询本地DNS 服务器来解析该名称。客户机发送的每条查询消息都包括3条信息，以指定服务器应回答的问题。

● 指定的 DNS 域名，表示为完全合格的域名 (FQDN) 。

● 指定的查询类型，它可根据类型指定资源记录，或作为查询操作的专门类型。

● DNS 域名的指定类别。

对于 DNS 服务器，它始终应指定为 Internet 类别。例如，指定的名称可以是计算机的完全合格的域名，如im.qq.com，并且指定的查询类型用于通过该名称搜索地址资源记录。

DNS 查询以各种不同的方式进行解析。客户机有时也可通过使用从以前查询获得的缓存信息就地应答查询。DNS 服务器可使用其自身的资源记录信息缓存来应答查询，也可代表请求客户机来查询或联系其他 DNS 服务器，以完全解析该名称，并随后将应答返回至客户机。这个过程称为递归。

另外，客户机自己也可尝试联系其他的 DNS 服务器来解析名称。如果客户机这么做，它会使用基于服务器应答的独立和附加的查询，该过程称作迭代，即DNS服务器之间的交互查询就是迭代查询。

DNS的查询过程如下所示：

1、在浏览器中输入`www.qq.com` 域名，操作系统会先检查自己本地的hosts文件是否有这个网址映射关系，如果有，就先调用这个 IP 地址映射，完成域名解析。

2、如果 hosts 里没有这个域名的映射，则查找本地 DNS 解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。

3、如果 hosts 与本地 DNS 解析器缓存都没有相应的网址映射关系，首先会找 TCP/IP 参数中设置的首选 DNS 服务器，在此我们叫它本地 DNS 服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。

4、如果要查询的域名，不由本地 DNS 服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个 IP 地址映射，完成域名解析，此解析不具有权威性。

5、如果本地 DNS 服务器本地区域文件与缓存解析都失效，则根据本地 DNS 服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地 DNS 就把请求发至 13 台根 DNS，根 DNS 服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个 IP。本地 DNS 服务器收到IP信息后，将会联系负责 .com 域的这台服务器。这台负责 .com 域的服务器收到请求后，如果自己无法解析，它就会找一个管理 .com 域的下一级DNS服务器地址`http://qq.com`给本地 DNS 服务器。当本地DNS服务器收到这个地址后，就会找`http://qq.com`域服务器，重复上面的动作，进行查询，直至找到`www.qq.com`主机。

6、如果用的是转发模式，此 DNS 服务器就会把请求转发至上一级 DNS 服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根 DNS 或把转请求转至上上级，以此循环。不管是本地 DNS 服务器用是是转发，还是根提示，最后都是把结果返回给本地 DNS服务器，由此 DNS 服务器再返回给客户机。

从客户端到本地 DNS 服务器是属于递归查询，而 DNS 服务器之间就是的交互查询就是迭代查询。